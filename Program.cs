namespace vulnerability_demo_os_command_injection
{
  class Program
  {
    private static string SETUP_OPTION_TERM = "--setup";

    static void Main(string[] args)
    {
      if (args.Length != 1)
      {
        System.Console.WriteLine("Usage: dotnet run :FOLDER");
        System.Console.WriteLine("Setup: dotnet run --setup");
      }
      else if (IsSetupExecution(args))
      {
        System.Console.WriteLine("Setting project up...");
        Setup();
        System.Console.WriteLine("Project set up.");

        return;
      }
      else
      {
        string folder = args[0];
        System.Console.WriteLine($"Listing files at {folder}");

        var setupExecution = GetSafeExecutionToListFiles(folder);
        var result = setupExecution.Execute();

        System.Console.WriteLine($"Result:\n{result}");
      }
    }

    static void Setup()
    {
      var setupExecution = new ExecutionInBash("cp -r ./\\.seed ./reports");
      setupExecution.Execute();
    }

    static bool IsSetupExecution(string[] args)
    {
      return args.Length == 1 && args[0] == SETUP_OPTION_TERM;
    }

    static IOsCommandExecution GetUnsafeExecutionToListFiles(string folder)
    {
      return new ExecutionInBash($"ls {folder}");
    }

    static IOsCommandExecution GetSafeExecutionToListFiles(string folder)
    {
      return new ExecutionInBash($"ls \\\"{folder}\\\"");
    }
  }
}
